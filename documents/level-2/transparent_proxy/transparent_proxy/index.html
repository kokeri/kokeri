<!doctype html><html><head><title>透明代理入门 :: Project X</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=revised content="2021-02-09T14:04:28 UTC"><meta name=description content="Project X 的文档."><meta name=author content="Project X"><title>透明代理入门 :: Project X</title><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css integrity=sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel=stylesheet><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/layout.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.main.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.menu.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/notice.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/tabs.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/panel.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/columns.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/children.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/attachments.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/alert.css><link rel=stylesheet type=text/css href=/css/docport.css><script src=/js/docport.js></script><script type=text/javascript>var baseurl="https:\/\/xtls.github.io";</script><link rel=stylesheet href=/css/custom.css></head><body data-url=/documents/level-2/transparent_proxy/transparent_proxy/><style type=text/css>#debug{display:-webkit-box;display:-ms-flexbox;display:flex;line-height:3.5rem;margin-bottom:.35rem;padding:0 2rem;position:fixed;left:0;right:0;top:0;top:0;min-height:150px;background-color:#fff;border:3px solid red;z-index:10000;word-wrap:all;overflow:auto}</style><header><div><div class=burger><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')">&#9776;</a></div><div><a class=baselink href=https://xtls.github.io>Project X</a></div><nav class=shortcuts><li role><a href=/about/new rel=noopener>What's New</a></li><li role><a href=https://github.com/XTLS rel=noopener>GitHub</a></li><li role><a href=https://github.com/XTLS/Xray-core/releases rel=noopener>Download</a></li><li role><a href=https://xtls.github.io/ rel=noopener>Documentation</a></li></nav></div></header><article><aside><div class=search><div class=searchbox><input data-search-input id=search-by type=text placeholder></div><script type=text/javascript src=/vendor/lunr/lunr.min.js></script><script type=text/javascript src=/vendor/auto-complete/auto-complete.js></script><link href=/vendor/auto-complete/auto-complete.css rel=stylesheet><script type=text/javascript>var baseurl="https:\/\/xtls.github.io";</script><script type=text/javascript src=/js/search.js></script></div><center><a class=github-button href=https://github.com/XTLS/Xray-core/releases data-icon=octicon-cloud-download aria-label="Download vjeantet/hugo-theme-docport on GitHub">Download</a>
<a class=github-button href=https://github.com/XTLS/Xray-core data-icon=octicon-star data-show-count=false aria-label="Star vjeantet/hugo-theme-docport on GitHub">Star</a>
<a class=github-button href=https://github.com/XTLS/Xray-core/fork data-icon=octicon-repo-forked data-show-count=true aria-label="Fork vjeantet/hugo-theme-docport on GitHub">Fork</a></center>
<script async defer src=https://buttons.github.io/buttons.js></script><div id=close_menu><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')"><i class="fa fa-lg fa-times"></i></a></div><ul class=menu><hr><li data-nav-id=https://xtls.github.io/about/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/about/>Project X&nbsp;⚡</a><ul><li data-nav-id=https://xtls.github.io/about/new/ class="dd-item
item_level_$level"><a href=/about/new/>大史记&nbsp;</a></li></ul></li><hr><li data-nav-id=https://xtls.github.io/guide/ class="dd-item alwaysopen
item_level_$level"><a href=/guide/>快速入门&nbsp;</a></li><li data-nav-id=https://xtls.github.io/config/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/config/>配置文件&nbsp;📜</a><ul><li data-nav-id=https://xtls.github.io/config/base/ class="dd-item haschildren
item_level_$level"><a href=/config/base/>基础配置模块&nbsp;</a>
<i class="fas fa-chevron-right ddexp"></i><ul><li data-nav-id=https://xtls.github.io/config/base/log/ class="dd-item
item_level_$level"><a href=/config/base/log/>日志配置</a></li><li data-nav-id=https://xtls.github.io/config/base/api/ class="dd-item
item_level_$level"><a href=/config/base/api/>API接口</a></li><li data-nav-id=https://xtls.github.io/config/base/dns/ class="dd-item
item_level_$level"><a href=/config/base/dns/>内置DNS服务器</a></li><li data-nav-id=https://xtls.github.io/config/base/routing/ class="dd-item
item_level_$level"><a href=/config/base/routing/>路由</a></li><li data-nav-id=https://xtls.github.io/config/base/policy/ class="dd-item
item_level_$level"><a href=/config/base/policy/>本地策略</a></li><li data-nav-id=https://xtls.github.io/config/base/inbounds/ class="dd-item
item_level_$level"><a href=/config/base/inbounds/>Inbounds</a></li><li data-nav-id=https://xtls.github.io/config/base/outbounds/ class="dd-item
item_level_$level"><a href=/config/base/outbounds/>Outbounds</a></li><li data-nav-id=https://xtls.github.io/config/base/transport/ class="dd-item
item_level_$level"><a href=/config/base/transport/>传输方式</a></li><li data-nav-id=https://xtls.github.io/config/base/stats/ class="dd-item
item_level_$level"><a href=/config/base/stats/>统计信息</a></li><li data-nav-id=https://xtls.github.io/config/base/reverse/ class="dd-item
item_level_$level"><a href=/config/base/reverse/>反向代理</a></li></ul></li><li data-nav-id=https://xtls.github.io/config/inbound-protocols/ class="dd-item
item_level_$level"><a href=/config/inbound-protocols/>Inbounds 可用协议列表</a></li><li data-nav-id=https://xtls.github.io/config/outbound-protocols/ class="dd-item
item_level_$level"><a href=/config/outbound-protocols/>Outbounds 可用协议列表</a></li><li data-nav-id=https://xtls.github.io/config/transports/ class="dd-item
item_level_$level"><a href=/config/transports/>传输方式列表</a></li><li data-nav-id=https://xtls.github.io/config/vless/ class="dd-item
item_level_$level"><a href=/config/vless/>VLESS 协议详解</a></li><li data-nav-id=https://xtls.github.io/config/fallback/ class="dd-item
item_level_$level"><a href=/config/fallback/>Fallbacks</a></li><li data-nav-id=https://xtls.github.io/config/xtls/ class="dd-item
item_level_$level"><a href=/config/xtls/>XTLS 深度剖析</a></li><li data-nav-id=https://xtls.github.io/config/env/ class="dd-item
item_level_$level"><a href=/config/env/>环境变量</a></li><li data-nav-id=https://xtls.github.io/config/multiple_config/ class="dd-item alwaysopen
item_level_$level"><a href=/config/multiple_config/>多文件配置</a></li></ul></li><li data-nav-id=https://xtls.github.io/documents/ class="dd-item parent haschildren
item_level_$level"><i class="fas fa-chevron-down ddexp"></i><a href=/documents/>使用心得&nbsp;📚</a><ul><li data-nav-id=https://xtls.github.io/documents/level-0/ class="dd-item alwaysopen
item_level_$level"><a href=/documents/level-0/>小小白白话文&nbsp;📙</a></li><li data-nav-id=https://xtls.github.io/documents/level-1/ class="dd-item alwaysopen
item_level_$level"><a href=/documents/level-1/>入门技巧&nbsp;📚</a></li><li data-nav-id=https://xtls.github.io/documents/level-2/ class="dd-item parent active alwaysopen
item_level_$level"><a href=/documents/level-2/>进阶文档&nbsp;📘</a></li></ul></li><li data-nav-id=https://xtls.github.io/develop/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/develop/>开发指南&nbsp;🖥️</a><ul><li data-nav-id=https://xtls.github.io/develop/intro/ class="dd-item alwaysopen
item_level_$level"><a href=/develop/intro/>开发手册</a></li><li data-nav-id=https://xtls.github.io/develop/protocols/ class="dd-item alwaysopen
item_level_$level"><a href=/develop/protocols/>协议详解</a></li></ul></li><li data-nav-id=https://xtls.github.io/faq/ class="dd-item alwaysopen
item_level_$level"><a href=/faq/>常见问答&nbsp;💬</a></li><li data-nav-id=https://xtls.github.io/caseslip/ class="dd-item alwaysopen
item_level_$level"><a href=/caseslip/>大案牍术&nbsp;</a></li><hr><li data-nav-id=https://xtls.github.io/links/ class="dd-item alwaysopen
item_level_$level"><a href=/links/>常用链接&nbsp;🤝</a></li></ul></aside><section class=page><nav id=ariane aria-label=breadcrumb><ol class=ariane><li><a class=text-link href=https://xtls.github.io></a></li><li><a class=text-link href=/documents/>使用心得</a></li><li><a class=text-link href=/documents/level-2/>进阶文档</a></li><li class=active>透明代理入门</li></ol></nav><h1>进阶文档<span>透明代理入门</span></h1><nav class=subpages><li class=active><a title=$pagetitle href=/documents/level-2/transparent_proxy/transparent_proxy/>透明代理入门</a></li><li><a title=$pagetitle href=/documents/level-2/tproxy/>透明代理（TProxy）配置教程</a></li><li><a title=$pagetitle href=/documents/level-2/iptables_gid/>透明代理通过gid规避Xray流量</a></li></nav><div class=jump-to-section><span onclick="$h=$(this);$h.next('nav').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('nav').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right';});});"><span class="fas fa-align-right"></span><i class="fas fa-chevron-right"></i></span><nav id=TableOfContents><ul><li><a href=#什么是透明代理>什么是透明代理</a></li><li><a href=#透明代理的实现>透明代理的实现</a><ul><li><a href=#tun2socks>tun2socks</a></li><li><a href=#iptablesnftables>iptables/nftables</a></li></ul></li><li><a href=#iptables实现透明代理原理>iptables实现透明代理原理</a></li><li><a href=#透明代理难在哪里>透明代理难在哪里</a></li><li><a href=#从零开始一步步实现基于iptables-tproxy的透明代理>从零开始一步步实现基于iptables-tproxy的透明代理</a><ul><li><a href=#在开始之前你需要有一定的基础知识>在开始之前，你需要有一定的基础知识：</a></li><li><a href=#前期准备工作>前期准备工作</a></li><li><a href=#首先我们先试试做到第一阶段>首先，我们先试试做到第一阶段</a></li><li><a href=#第二阶段>第二阶段</a></li><li><a href=#第三阶段>第三阶段</a></li><li><a href=#第四阶段>第四阶段</a></li><li><a href=#代理ipv6>代理ipv6</a></li></ul></li></ul></nav></div><div class=content><h2 ref=什么是透明代理>什么是透明代理</h2><a class=anchor id=什么是透明代理></a><p>透明代理简单地说就是不让被代理的设备感觉到自己被代理了。简单地说就是，被代理的设备上不需要运行任何代理软件(比如Xray、V2RayNG等)，当你连接上网络时，你的设备已经被代理了。</p><p>这也意味着，代理的软件运行在别的地方，比如运行在路由器中，通过路由器上网的设备就自动被代理了。</p><h2 ref=透明代理的实现>透明代理的实现</h2><a class=anchor id=透明代理的实现></a><p>透明代理的实现目前主要有两种方式：</p><h3 ref=tun2socks>tun2socks</h3><a class=anchor id=tun2socks></a><p>可用Windows/Linux(包括安卓)实现。因为实现过程比较简单，很少有教程，我这里简单描述一下。</p><p><strong>Windows</strong></p><ol><li><p>安装 <strong><a href=https://github.com/NetchX/Netch/releases>Netch</a></strong> ，使用模式<code>[3] [TUN/TAP] 绕过局域网</code>启动。</p></li><li><p>开启热点</p></li><li><p>打开<code>控制面板</code>-><code>网络和 Internet</code>-><code>网络和共享中心</code>-><code>更改适配器设置</code>，找到<code>TAP-Windows Adapter</code>和<code>Microsoft Wi-Fi Direct Virtual Adapter</code>。</p></li><li><p>鼠标右键点击<code>TAP-Windows Adapter</code>，<code>属性</code>-><code>共享</code>，勾选<code>允许其他网络用户通过此计算机的 Internet 连接来连接</code>，在<code>家庭网络连接</code>中选择<code>Microsoft Wi-Fi Direct Virtual Adapter</code>的那个网络连接，点击确定。</p></li></ol><p><strong>Android</strong></p><ol><li><p>配置连接V2RayNG</p></li><li><p>开启热点</p></li><li><p>热点设置 -> 允许热点使用VPN(部分安卓系统可能没有这个选项)</p></li></ol><h3 ref=iptablesnftables>iptables/nftables</h3><a class=anchor id=iptablesnftables></a><p>iptables与nftables实现透明代理的原理相同，下文统一使用iptables。</p><p>基于iptables的透明代理实现只能用于Linux系统(包括openwrt/安卓)。由于其比tun2socks更高效率以及适合在路由器中配置而广泛使用。</p><p>现存的三篇白话文透明代理教程其实讲的都是基于这种方案的透明代理实现，它们是： <strong><a href=https://guide.v2fly.org/app/transparent_proxy.html>新 V2Ray 白话文指南-透明代理</a></strong> 、 <strong><a href=https://guide.v2fly.org/app/tproxy.html>新 V2Ray 白话文指南-透明代理(TPROXY)</a></strong> 、 <strong><a href=../../tproxy>透明代理（TProxy）配置教程</a></strong> 。其中第一篇是基于iptables-redirect模式，已经过时了，不建议使用，仅供参考。第二篇和第三篇讲的都是基于iptables-tproxy模式的透明代理实现。</p><h2 ref=iptables实现透明代理原理>iptables实现透明代理原理</h2><a class=anchor id=iptables实现透明代理原理></a><p>Linux使用<code>Netfilter</code>来管理网络，<code>Netfilter</code>模型如下：</p><p><img src=../netfilter.png alt=Netfilter></p><p><strong>假设使用路由器作为网关(即我们平时的上网方式)，那么：</strong></p><p>局域网设备通过路由器访问互联网的流量方向：</p><p><code>PREROUTING链->FORWARD链->POSTINGROUTING链</code></p><p>局域网设备访问路由器的流量(如登陆路由器web管理界面/ssh连接路由器/访问路由器的dns服务器等)方向：</p><p><code>PREROUTING链->INPUT链->网关本机</code></p><p>路由器访问互联网的流量方向：</p><p><code>网关本机->OUTPUT链->POSTINGROUTING链</code></p><p><strong>通过使用iptables操控<code>PREROUTING链</code>和<code>OUTPUT链</code>的流量走向，转发到Xray，就可以代理局域网设备和网关本机。</strong></p><h2 ref=透明代理难在哪里>透明代理难在哪里</h2><a class=anchor id=透明代理难在哪里></a><p>透明代理的难点就在于路由，所谓路由，就是区分哪些流量是直连的，哪些该被代理，所以我个人认为叫做<strong>分流</strong>更加合适。</p><p>我们可以把路由由易到难分为以下几个阶段：</p><ol><li><p>代理全部请求</p></li><li><p>本地局域网IP/组播IP请求直连，其它请求代理</p></li><li><p>在2的基础上直连Xray发起的连接请求</p></li><li><p>在3的基础上直连指向中国大陆IP的连接请求，并对国内外域名选择国内外DNS服务器解析。</p></li></ol><p>上面说的三篇教程，都是在第四阶段。所以新手直接阅读可能显得有点难懂。</p><h2 ref=从零开始一步步实现基于iptables-tproxy的透明代理>从零开始一步步实现基于iptables-tproxy的透明代理</h2><a class=anchor id=从零开始一步步实现基于iptables-tproxy的透明代理></a><h3 ref=在开始之前你需要有一定的基础知识>在开始之前，你需要有一定的基础知识：</h3><a class=anchor id=在开始之前你需要有一定的基础知识></a><ol><li><p>大概知道什么是TCP/IP协议、域名和DNS服务器</p></li><li><p>知道什么是WAN口，LAN口，LAN_IP，WAN_IP以及DHCP服务器。对于旁路由，只有一个网口，这里称其为LAN口</p></li><li><p>对Linux系统有最基础的了解(知道怎么运行命令)</p></li><li><p>能够手写客户端json文件配置，至少要能看懂</p></li></ol><h3 ref=前期准备工作>前期准备工作</h3><a class=anchor id=前期准备工作></a><p><strong>1. 准备一个运行Linux系统的网关</strong></p><p>比如，刷了OpenWRT的路由器</p><p><strong>2. 在网关(路由器)准备好Xray可执行文件以及配置文件</strong></p><p>配置文件监听12345端口，开启tproxy：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;log&#34;</span>: {
    <span style=color:#f92672>&#34;loglevel&#34;</span>: <span style=color:#e6db74>&#34;warning&#34;</span>
  },
  <span style=color:#f92672>&#34;inbounds&#34;</span>: [
    {
      <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>12345</span>,
      <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;dokodemo-door&#34;</span>,
      <span style=color:#f92672>&#34;settings&#34;</span>: {
        <span style=color:#f92672>&#34;network&#34;</span>: <span style=color:#e6db74>&#34;tcp,udp&#34;</span>,
        <span style=color:#f92672>&#34;followRedirect&#34;</span>: <span style=color:#66d9ef>true</span>
      },
      <span style=color:#f92672>&#34;streamSettings&#34;</span>: {
        <span style=color:#f92672>&#34;sockopt&#34;</span>: {
          <span style=color:#f92672>&#34;tproxy&#34;</span>: <span style=color:#e6db74>&#34;tproxy&#34;</span>
        }
      }
    }
  ],
  <span style=color:#f92672>&#34;outbounds&#34;</span>: [
    {
       <span style=color:#960050;background-color:#1e0010>你的服务器配置</span>
    }
  ]
}
</code></pre></div><p>我们由易到难，不写routing，只写一个inbound一个outbound。</p><h3 ref=首先我们先试试做到第一阶段>首先，我们先试试做到第一阶段</h3><a class=anchor id=首先我们先试试做到第一阶段></a><p>将所有<code>PREROUTING链</code>的流量，都转发到Xray中。</p><p>运行Xray，执行以下指令：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ip rule add fwmark <span style=color:#ae81ff>1</span> table <span style=color:#ae81ff>100</span>
ip route add local 0.0.0.0/0 dev lo table <span style=color:#ae81ff>100</span>
iptables -t mangle -N XRAY
iptables -t mangle -A XRAY -p tcp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A XRAY -p udp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A PREROUTING -j XRAY
</code></pre></div><p>当你输入完之后，如果你是使用ssh连接到网关上的，你会发现ssh的连接断开了(不用紧张，断电重启即可恢复)，并且透明代理无法上网；如果你是的网关是虚拟机，你会发现网关本身也无法上网，并且Xray日志access_log中出现许多源地址为目标地址，目标地址为WAN_IP的请求。</p><p>理论上网关本机访问公网只会经过<code>OUTPUT链</code>和<code>POSTROUTING链</code>，为什么操控<code>PREROUTING链</code>会导致网关无法上网呢？这是因为网络通讯往往是双向的，虽然网关访问公网IP不需要经过<code>PREROUTING链</code>，但被访问的服务器向网关返回信息时要经过<code>PREROUTING链</code>，且这部分被转发到Xray了，因此出现了日志中的反向请求。</p><p>我们修改一下规则，源IP不是来自局域网的则返回。重启网关，运行Xray，执行以下指令：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ip rule add fwmark <span style=color:#ae81ff>1</span> table <span style=color:#ae81ff>100</span>
ip route add local 0.0.0.0/0 dev lo table <span style=color:#ae81ff>100</span>
iptables -t mangle -N XRAY
<span style=color:#75715e># &#34;网关LAN_IP地址段&#34; 通过运行命令&#34;ip address | grep -w &#34;inet&#34; | awk &#39;{print $2}&#39;&#34;获得，是其中的一个</span>
iptables -t mangle -A XRAY ! -s 网关LAN_IP地址段 -j RETURN
iptables -t mangle -A XRAY -p tcp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A XRAY -p udp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A PREROUTING -j XRAY
</code></pre></div><p>然后你会发现，虽然ssh连接断开了，但是透明代理已经可用了。只要我们修改系统dns为公共dns，就能正常上网了(因为现在网关访问不了，所以dns设置为网关是不行的)。</p><p>至此，第一阶段就完成了。之所以无法访问网关，是因为代理规则代理了全部流量，包括访问网关的流量。试想在VPS上访问你本地的网关，肯定是访问不了的，所以我们要对这部分流量直连，请看第二阶段：</p><h3 ref=第二阶段>第二阶段</h3><a class=anchor id=第二阶段></a><p>重启网关，运行Xray，执行以下指令：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ip rule add fwmark <span style=color:#ae81ff>1</span> table <span style=color:#ae81ff>100</span>
ip route add local 0.0.0.0/0 dev lo table <span style=color:#ae81ff>100</span>
iptables -t mangle -N XRAY

<span style=color:#75715e># 所有目标地址在网关所在网段的请求直连</span>
<span style=color:#75715e># 通过运行命令&#34;ip address | grep -w &#34;inet&#34; | awk &#39;{print $2}&#39;&#34;获得，一般来说有多个</span>
iptables -t mangle -A XRAY -d 网关所在网段1 -j RETURN
iptables -t mangle -A XRAY -d 网关所在网段2 -j RETURN
...

<span style=color:#75715e># 目标地址为组播IP的请求直连</span>
iptables -t mangle -A XRAY -d 224.0.0.0/4 -j RETURN
iptables -t mangle -A XRAY -d 255.255.255.255/32 -j RETURN

iptables -t mangle -A XRAY -p tcp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A XRAY -p udp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A PREROUTING -j XRAY
</code></pre></div><p>使用这条规则后，上一条规则<code>iptables -t mangle -A XRAY ! -s 网关LAN_IP地址段 -j RETURN</code>便成为了多余规则，可以删去。</p><p>至此，第二阶段完成。网关已经可以访问，ssh不会断开。</p><h3 ref=第三阶段>第三阶段</h3><a class=anchor id=第三阶段></a><p>我们平时用的DNS一般来自路由器，但这个iptables规则只代理了局域网中的设备，却没有代理网关本机，这样返回的DNS查询结果可能是错误的或者污染的。</p><p>iptables-tproxy不支持对<code>OUTPUT链</code>操作，但是<code>Netfilter</code>有个特性，在<code>OUTPUT链</code>给包打标记为<code>1</code>后相应的包会重路由到<code>PREROUTING链</code>上。所以我们就给网关本机需要代理的请求在<code>OUTPUT链</code>上标记<code>1</code>即可。</p><p>如果要代理网关本机发出的的全部请求，就会引入一个问题，Xray运行在网关，Xray向代理服务端发送请求，这个请求又被代理了，就形成了回环。</p><p>因此要代理网关本机，就要避免回环发生，即代理规则中规避Xray请求的流量。</p><p><strong>常见的方法有三种：</strong></p><ol><li>直连目标地址为VPS的流量</li></ol><p>重启网关，运行Xray，执行以下指令：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#75715e>#代理局域网设备</span>
<span style=color:#75715e>#继承上一个阶段的成果</span>
ip rule add fwmark <span style=color:#ae81ff>1</span> table <span style=color:#ae81ff>100</span>
ip route add local 0.0.0.0/0 dev lo table <span style=color:#ae81ff>100</span>
iptables -t mangle -N XRAY
iptables -t mangle -A XRAY -d 网关所在网段1 -j RETURN
iptables -t mangle -A XRAY -d 网关所在网段2 -j RETURN
...
iptables -t mangle -A XRAY -d 224.0.0.0/4 -j RETURN
iptables -t mangle -A XRAY -d 255.255.255.255/32 -j RETURN
iptables -t mangle -A XRAY -p tcp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A XRAY -p udp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A PREROUTING -j XRAY

<span style=color:#75715e>#代理网关本机</span>
iptables -t mangle -N XRAY_MASK
iptables -t mangle -A XRAY_MASK -d 网关所在网段1 -j RETURN
iptables -t mangle -A XRAY_MASK -d 网关所在网段2 -j RETURN
...
iptables -t mangle -A XRAY_MASK -d 224.0.0.0/4 -j RETURN
iptables -t mangle -A XRAY_MASK -d 255.255.255.255/32 -j RETURN
iptables -t mangle -A XRAY_MASK -d VPS公网ip/32 -j RETURN
iptables -t mangle -A XRAY_MASK -j MARK --set-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A OUTPUT -p tcp -j XRAY_MASK
iptables -t mangle -A OUTPUT -p udp -j XRAY_MASK
</code></pre></div><p>但是这么配置有个缺点，如果使用CDN或者VPS很多的话，就不好写规则了。</p><ol start=2><li>通过mark规避</li></ol><p>三个白话文教程都是使用这种方法规避，自行参考，这里不再赘述。</p><ol start=3><li>通过gid规避(推荐)</li></ol><p>参考 <strong><a href=../../iptables_gid>[透明代理]通过gid规避Xray流量</a></strong></p><p>这样就完成了第三阶段的代理，也就是平时说的全局代理。但是记得把网关的DNS服务器设置为国外的DNS服务器，否则可能依然返回被污染的结果。</p><h3 ref=第四阶段>第四阶段</h3><a class=anchor id=第四阶段></a><p>其实，并不是所有人都需要实现第四阶段。全局代理对于大部分情况已经适用。</p><p>特别是对于旁路由而言。需要代理时，将网关调成旁路由的IP，不需要代理时，将网关换回主路由IP。</p><p>至于第四阶段的具体实现，那三篇白话文教程讲的都是。在理解了上面的内容后，再去看那三篇白话文教程，就比较容易理解了。</p><h3 ref=代理ipv6>代理ipv6</h3><a class=anchor id=代理ipv6></a><p>上面的规则只对ipv4生效，如果还想要代理ipv6请求，则使用ip6tables命令，用法与iptables基本相同。参考 <strong><a href=../../iptables_gid#4-%E8%AE%BE%E7%BD%AEiptables%E8%A7%84%E5%88%99>[透明代理]通过gid规避Xray流量#4-设置iptables规则</a></strong></p><h1 ref=iptables透明代理的其它注意事项>iptables透明代理的其它注意事项</h1><a class=anchor id=iptables透明代理的其它注意事项></a><ol><li><p>如果作为代理的网关作为主路由，要在<code>PREROUTING链</code>规则中加一条<code>iptables -t mangle -A XRAY ! -s 网关LAN_IP地址段 -j RETURN</code>，即在第一阶段使用、第二阶段被删除的指令。如果不写，WAN口中同网段的其它人可以将网关填写成你的WAN_IP，从而蹭你的透明代理用，还可能带来一定的危险性。</p></li><li><p><strong><a href=https://guide.v2fly.org/app/tproxy.html#%E8%AE%BE%E7%BD%AE%E7%BD%91%E5%85%B3>新 V2Ray 白话文指南-透明代理(TPROXY)#设置网关</a></strong> 中的第三条说：<code>手动配置 PC 的网络，将默认网关指向树莓派的地址即 192.168.1.22。此时 PC 应当能正常上网（由于还没设置代理，“正常”是指可以上国内的网站）</code>。实际上，Ubuntu、CentOS、debian等系统就算开启了IP转发，PC也不能正常上网，这是正常的。事实上只有OpenWRT能做到文中所描述的那样，据 <strong><a href=https://github.com/BioniCosmos>@BioniCosmos</a></strong> 点拨，这是由于一般的Linux系统没有Masquery规则。</p></li><li><p><strong><a href=https://guide.v2fly.org/app/tproxy.html#%E8%A7%A3%E5%86%B3-too-many-open-files-%E9%97%AE%E9%A2%98>too many open files 问题</a></strong> ，解决方法见 <strong><a href=../../iptables_gid#3-%E9%85%8D%E7%BD%AE%E6%9C%80%E5%A4%A7%E6%96%87%E4%BB%B6%E5%A4%A7%E5%BC%80%E6%95%B0%E8%BF%90%E8%A1%8Cxray%E5%AE%A2%E6%88%B7%E7%AB%AF>[透明代理]通过gid规避Xray流量-配置最大文件大开数&运行Xray客户端</a></strong></p></li><li><p>关于开启ip_forward，待补充&mldr;</p></li><li><p>避免已有连接的包二次通过 TPROXY ,待补充&mldr;</p></li><li><p>主路由、单臂路由与旁路由，待补充&mldr;</p></li></ol></div><div class=chevrons></div></section><section class=right-menu><div class=TableOfContents><label><i class="fas fa-align-right"></i>&nbsp;&nbsp;</label><nav><ul><li><a href=/documents/level-2/transparent_proxy/transparent_proxy/>透明代理入门</a></li></ul></nav><nav id=TableOfContents><ul><li><a href=#什么是透明代理>什么是透明代理</a></li><li><a href=#透明代理的实现>透明代理的实现</a><ul><li><a href=#tun2socks>tun2socks</a></li><li><a href=#iptablesnftables>iptables/nftables</a></li></ul></li><li><a href=#iptables实现透明代理原理>iptables实现透明代理原理</a></li><li><a href=#透明代理难在哪里>透明代理难在哪里</a></li><li><a href=#从零开始一步步实现基于iptables-tproxy的透明代理>从零开始一步步实现基于iptables-tproxy的透明代理</a><ul><li><a href=#在开始之前你需要有一定的基础知识>在开始之前，你需要有一定的基础知识：</a></li><li><a href=#前期准备工作>前期准备工作</a></li><li><a href=#首先我们先试试做到第一阶段>首先，我们先试试做到第一阶段</a></li><li><a href=#第二阶段>第二阶段</a></li><li><a href=#第三阶段>第三阶段</a></li><li><a href=#第四阶段>第四阶段</a></li><li><a href=#代理ipv6>代理ipv6</a></li></ul></li></ul></nav></div><div class=Actions><nav><ul><li><a href=https://github.com/XTLS/XTLS.github.io/tree/main/content/documents/level-2/transparent_proxy/transparent_proxy.md target=blank><i class="fab fa-github"></i></a></li><li><i class="fas fa-calendar"></i>23 December 2020</li></ul></nav></div></section></article><footer><footer><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/twitter><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/stack><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/XTLS><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2020-2021 ProjectX Community All Rights Reserved</small></div></div></div></footer></footer></body></html>