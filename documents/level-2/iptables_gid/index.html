<!doctype html><html><head><title>透明代理通过gid规避Xray流量 :: Project X</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=revised content="2021-02-09T14:04:28 UTC"><meta name=description content="Project X 的文档."><meta name=author content="Project X"><title>透明代理通过gid规避Xray流量 :: Project X</title><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css integrity=sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel=stylesheet><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/layout.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.main.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.menu.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/notice.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/tabs.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/panel.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/columns.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/children.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/attachments.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/alert.css><link rel=stylesheet type=text/css href=/css/docport.css><script src=/js/docport.js></script><script type=text/javascript>var baseurl="https:\/\/xtls.github.io";</script><link rel=stylesheet href=/css/custom.css></head><body data-url=/documents/level-2/iptables_gid/><style type=text/css>#debug{display:-webkit-box;display:-ms-flexbox;display:flex;line-height:3.5rem;margin-bottom:.35rem;padding:0 2rem;position:fixed;left:0;right:0;top:0;top:0;min-height:150px;background-color:#fff;border:3px solid red;z-index:10000;word-wrap:all;overflow:auto}</style><header><div><div class=burger><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')">&#9776;</a></div><div><a class=baselink href=https://xtls.github.io>Project X</a></div><nav class=shortcuts><li role><a href=/about/new rel=noopener>What's New</a></li><li role><a href=https://github.com/XTLS rel=noopener>GitHub</a></li><li role><a href=https://github.com/XTLS/Xray-core/releases rel=noopener>Download</a></li><li role><a href=https://xtls.github.io/ rel=noopener>Documentation</a></li></nav></div></header><article><aside><div class=search><div class=searchbox><input data-search-input id=search-by type=text placeholder></div><script type=text/javascript src=/vendor/lunr/lunr.min.js></script><script type=text/javascript src=/vendor/auto-complete/auto-complete.js></script><link href=/vendor/auto-complete/auto-complete.css rel=stylesheet><script type=text/javascript>var baseurl="https:\/\/xtls.github.io";</script><script type=text/javascript src=/js/search.js></script></div><center><a class=github-button href=https://github.com/XTLS/Xray-core/releases data-icon=octicon-cloud-download aria-label="Download vjeantet/hugo-theme-docport on GitHub">Download</a>
<a class=github-button href=https://github.com/XTLS/Xray-core data-icon=octicon-star data-show-count=false aria-label="Star vjeantet/hugo-theme-docport on GitHub">Star</a>
<a class=github-button href=https://github.com/XTLS/Xray-core/fork data-icon=octicon-repo-forked data-show-count=true aria-label="Fork vjeantet/hugo-theme-docport on GitHub">Fork</a></center>
<script async defer src=https://buttons.github.io/buttons.js></script><div id=close_menu><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')"><i class="fa fa-lg fa-times"></i></a></div><ul class=menu><hr><li data-nav-id=https://xtls.github.io/about/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/about/>Project X&nbsp;⚡</a><ul><li data-nav-id=https://xtls.github.io/about/new/ class="dd-item
item_level_$level"><a href=/about/new/>大史记&nbsp;</a></li></ul></li><hr><li data-nav-id=https://xtls.github.io/guide/ class="dd-item alwaysopen
item_level_$level"><a href=/guide/>快速入门&nbsp;</a></li><li data-nav-id=https://xtls.github.io/config/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/config/>配置文件&nbsp;📜</a><ul><li data-nav-id=https://xtls.github.io/config/base/ class="dd-item haschildren
item_level_$level"><a href=/config/base/>基础配置模块&nbsp;</a>
<i class="fas fa-chevron-right ddexp"></i><ul><li data-nav-id=https://xtls.github.io/config/base/log/ class="dd-item
item_level_$level"><a href=/config/base/log/>日志配置</a></li><li data-nav-id=https://xtls.github.io/config/base/api/ class="dd-item
item_level_$level"><a href=/config/base/api/>API接口</a></li><li data-nav-id=https://xtls.github.io/config/base/dns/ class="dd-item
item_level_$level"><a href=/config/base/dns/>内置DNS服务器</a></li><li data-nav-id=https://xtls.github.io/config/base/routing/ class="dd-item
item_level_$level"><a href=/config/base/routing/>路由</a></li><li data-nav-id=https://xtls.github.io/config/base/policy/ class="dd-item
item_level_$level"><a href=/config/base/policy/>本地策略</a></li><li data-nav-id=https://xtls.github.io/config/base/inbounds/ class="dd-item
item_level_$level"><a href=/config/base/inbounds/>Inbounds</a></li><li data-nav-id=https://xtls.github.io/config/base/outbounds/ class="dd-item
item_level_$level"><a href=/config/base/outbounds/>Outbounds</a></li><li data-nav-id=https://xtls.github.io/config/base/transport/ class="dd-item
item_level_$level"><a href=/config/base/transport/>传输方式</a></li><li data-nav-id=https://xtls.github.io/config/base/stats/ class="dd-item
item_level_$level"><a href=/config/base/stats/>统计信息</a></li><li data-nav-id=https://xtls.github.io/config/base/reverse/ class="dd-item
item_level_$level"><a href=/config/base/reverse/>反向代理</a></li></ul></li><li data-nav-id=https://xtls.github.io/config/inbound-protocols/ class="dd-item
item_level_$level"><a href=/config/inbound-protocols/>Inbounds 可用协议列表</a></li><li data-nav-id=https://xtls.github.io/config/outbound-protocols/ class="dd-item
item_level_$level"><a href=/config/outbound-protocols/>Outbounds 可用协议列表</a></li><li data-nav-id=https://xtls.github.io/config/transports/ class="dd-item
item_level_$level"><a href=/config/transports/>传输方式列表</a></li><li data-nav-id=https://xtls.github.io/config/vless/ class="dd-item
item_level_$level"><a href=/config/vless/>VLESS 协议详解</a></li><li data-nav-id=https://xtls.github.io/config/fallback/ class="dd-item
item_level_$level"><a href=/config/fallback/>Fallbacks</a></li><li data-nav-id=https://xtls.github.io/config/xtls/ class="dd-item
item_level_$level"><a href=/config/xtls/>XTLS 深度剖析</a></li><li data-nav-id=https://xtls.github.io/config/env/ class="dd-item
item_level_$level"><a href=/config/env/>环境变量</a></li><li data-nav-id=https://xtls.github.io/config/multiple_config/ class="dd-item alwaysopen
item_level_$level"><a href=/config/multiple_config/>多文件配置</a></li></ul></li><li data-nav-id=https://xtls.github.io/documents/ class="dd-item parent haschildren
item_level_$level"><i class="fas fa-chevron-down ddexp"></i><a href=/documents/>使用心得&nbsp;📚</a><ul><li data-nav-id=https://xtls.github.io/documents/level-0/ class="dd-item alwaysopen
item_level_$level"><a href=/documents/level-0/>小小白白话文&nbsp;📙</a></li><li data-nav-id=https://xtls.github.io/documents/level-1/ class="dd-item alwaysopen
item_level_$level"><a href=/documents/level-1/>入门技巧&nbsp;📚</a></li><li data-nav-id=https://xtls.github.io/documents/level-2/ class="dd-item parent active alwaysopen
item_level_$level"><a href=/documents/level-2/>进阶文档&nbsp;📘</a></li></ul></li><li data-nav-id=https://xtls.github.io/develop/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/develop/>开发指南&nbsp;🖥️</a><ul><li data-nav-id=https://xtls.github.io/develop/intro/ class="dd-item alwaysopen
item_level_$level"><a href=/develop/intro/>开发手册</a></li><li data-nav-id=https://xtls.github.io/develop/protocols/ class="dd-item alwaysopen
item_level_$level"><a href=/develop/protocols/>协议详解</a></li></ul></li><li data-nav-id=https://xtls.github.io/faq/ class="dd-item alwaysopen
item_level_$level"><a href=/faq/>常见问答&nbsp;💬</a></li><li data-nav-id=https://xtls.github.io/caseslip/ class="dd-item alwaysopen
item_level_$level"><a href=/caseslip/>大案牍术&nbsp;</a></li><hr><li data-nav-id=https://xtls.github.io/links/ class="dd-item alwaysopen
item_level_$level"><a href=/links/>常用链接&nbsp;🤝</a></li></ul></aside><section class=page><nav id=ariane aria-label=breadcrumb><ol class=ariane><li><a class=text-link href=https://xtls.github.io></a></li><li><a class=text-link href=/documents/>使用心得</a></li><li><a class=text-link href=/documents/level-2/>进阶文档</a></li><li class=active>透明代理通过gid规避Xray流量</li></ol></nav><h1>进阶文档<span>透明代理通过gid规避Xray流量</span></h1><nav class=subpages><li><a title=$pagetitle href=/documents/level-2/transparent_proxy/transparent_proxy/>透明代理入门</a></li><li><a title=$pagetitle href=/documents/level-2/tproxy/>透明代理（TProxy）配置教程</a></li><li class=active><a title=$pagetitle href=/documents/level-2/iptables_gid/>透明代理通过gid规避Xray流量</a></li></nav><div class=jump-to-section><span onclick="$h=$(this);$h.next('nav').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('nav').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right';});});"><span class="fas fa-align-right"></span><i class="fas fa-chevron-right"></i></span><nav id=TableOfContents><ul><li><a href=#思路>思路</a></li><li><a href=#配置过程>配置过程</a><ul><li><a href=#1-前期准备>1. 前期准备</a></li><li><a href=#2-添加用户安卓用户请忽略>2. 添加用户(安卓用户请忽略)</a></li><li><a href=#3-配置运行xray配置iptables规则>3. 配置运行Xray，配置iptables规则</a></li></ul></li><li><a href=#下面提供一个实现tproxy全局代理的完整配置过程>下面提供一个实现tproxy全局代理的完整配置过程</a><ul><li><a href=#1-完成-前期准备1-前期准备-和-添加用户2-添加用户安卓用户请忽略>1. 完成 <strong><a href=#1-%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87>前期准备</a></strong> 和 <strong><a href=#2-%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%AE%89%E5%8D%93%E7%94%A8%E6%88%B7%E8%AF%B7%E5%BF%BD%E7%95%A5>添加用户</a></strong></a></li><li><a href=#2-准备xray配置文件>2. 准备Xray配置文件</a></li><li><a href=#3-配置最大文件大开数运行xray客户端>3. 配置最大文件大开数&运行Xray客户端</a></li><li><a href=#4-设置iptables规则>4. 设置iptables规则</a></li></ul></li></ul></nav></div><div class=content><p>在现有的iptables透明代理白话文(<strong><a href=https://guide.v2fly.org/app/transparent_proxy.html>新 V2Ray 白话文指南-透明代理</a></strong> 、 <strong><a href=https://guide.v2fly.org/app/tproxy.html>新 V2Ray 白话文指南-透明代理(TPROXY)</a></strong> 、 <strong><a href=../tproxy>透明代理（TProxy）配置教程</a></strong>)教程中，对Xray流量的规避处理是打mark实现的。即对Xray出站流量打mark，通过设置iptables规则对对应mark的流量直连，来规避Xray流量，防止回环。</p><p>这么做有以下几个问题：</p><ol><li><p><strong><a href=https://github.com/v2ray/v2ray-core/issues/2621>莫名流量进入PREROUTING链</a></strong></p></li><li><p>安卓系统有自己的mark机制，该方案在安卓上不可用</p></li></ol><p>本教程的方案不需要设置mark，理论性能更高，同时也不存在上述问题。</p><h2 ref=思路>思路</h2><a class=anchor id=思路></a><p>tproxy流量只能被root权限用户(uid==0)或其他有CAP_NET_ADMIN权限的用户接收。</p><p>iptables规则可以通过uid(用户id)和gid(用户组id)分流。</p><p>让Xray运行在一个uid==0但gid!=0的用户上，设置iptables规则不代理该gid的流量来规避Xray流量。</p><h2 ref=配置过程>配置过程</h2><a class=anchor id=配置过程></a><h3 ref=1-前期准备>1. 前期准备</h3><a class=anchor id=1-前期准备></a><p><strong>安卓系统</strong></p><ol><li><p>系统已root</p></li><li><p>安装 <strong><a href="https://play.google.com/store/apps/details?id=stericson.busybox">busybox</a></strong></p></li><li><p>有一个可以执行命令的终端，可以使用adb shell，termux等。</p></li></ol><p><strong>其它Linux系统</strong></p><p>需要依赖sudo，iptables的tproxy模块和extra模块。</p><p>一般系统都有自带，openwrt运行：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>opkg install sudo iptables-mod-tproxy iptables-mod-extra
</code></pre></div><p>另附上一些openwrt常用的依赖，缺少可能导致Xray无法运行</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>opkg install libopenssl ca-certificates
</code></pre></div><h3 ref=2-添加用户安卓用户请忽略>2. 添加用户(安卓用户请忽略)</h3><a class=anchor id=2-添加用户安卓用户请忽略></a><p>安卓系统不支持/etc/passwd文件来管理用户，请忽略，直接下一步。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>grep -qw xray_tproxy /etc/passwd <span style=color:#f92672>||</span> echo <span style=color:#e6db74>&#34;xray_tproxy:x:0:23333:::&#34;</span> &gt;&gt; /etc/passwd
</code></pre></div><p>其中xray_tproxy是用户名，0是uid，23333是gid，用户名和gid可以自己定，uid必须为0。
检查用户是否添加成功，运行</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>sudo -u xray_tproxy id
</code></pre></div><p>显示的结果应该是uid为0，gid为23333</p><h3 ref=3-配置运行xray配置iptables规则>3. 配置运行Xray，配置iptables规则</h3><a class=anchor id=3-配置运行xray配置iptables规则></a><p>在现有的iptables透明代理白话文(<strong><a href=https://guide.v2fly.org/app/transparent_proxy.html>新 V2Ray 白话文指南-透明代理</a></strong> 、 <strong><a href=https://guide.v2fly.org/app/tproxy.html>新 V2Ray 白话文指南-透明代理(TPROXY)</a></strong> 、 <strong><a href=../tproxy>透明代理（TProxy）配置教程</a></strong>)教程的基础上修改：</p><ol><li><p>修改json配置文件，删除mark相关内容</p></li><li><p>修改iptables规则，删除mark相关内容，并在OUTPUT链应用规则处添加选项"-m owner ! &ndash;gid-owner 23333"。</p></li></ol><p>如：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>iptables -t mangle -A OUTPUT -j XRAY_SELF
</code></pre></div><p>改为</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>iptables -t mangle -A OUTPUT -m owner ! --gid-owner <span style=color:#ae81ff>23333</span> -j XRAY_SELF
</code></pre></div><ol start=3><li>修改运行Xray的方式，使其运行在uid为0，gid为23333的用户上，参考<a href=#3-%E9%85%8D%E7%BD%AE%E6%9C%80%E5%A4%A7%E6%96%87%E4%BB%B6%E5%A4%A7%E5%BC%80%E6%95%B0%E8%BF%90%E8%A1%8Cxray%E5%AE%A2%E6%88%B7%E7%AB%AF>这里</a>。</li></ol><h2 ref=下面提供一个实现tproxy全局代理的完整配置过程>下面提供一个实现tproxy全局代理的完整配置过程</h2><a class=anchor id=下面提供一个实现tproxy全局代理的完整配置过程></a><h3 ref=1-完成-前期准备1-前期准备-和-添加用户2-添加用户安卓用户请忽略>1. 完成 <strong><a href=#1-%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87>前期准备</a></strong> 和 <strong><a href=#2-%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%AE%89%E5%8D%93%E7%94%A8%E6%88%B7%E8%AF%B7%E5%BF%BD%E7%95%A5>添加用户</a></strong></h3><a class=anchor id=1-完成-前期准备1-前期准备-和-添加用户2-添加用户安卓用户请忽略></a><h3 ref=2-准备xray配置文件>2. 准备Xray配置文件</h3><a class=anchor id=2-准备xray配置文件></a><p>配置Xray任意门监听12345，开启followRedirect和tproxy，不需要设置sniffing：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;inbounds&#34;</span>: [
    {
      <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>12345</span>,
      <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;dokodemo-door&#34;</span>,
      <span style=color:#f92672>&#34;settings&#34;</span>: {
        <span style=color:#f92672>&#34;network&#34;</span>: <span style=color:#e6db74>&#34;tcp,udp&#34;</span>,
        <span style=color:#f92672>&#34;followRedirect&#34;</span>: <span style=color:#66d9ef>true</span>
      },
      <span style=color:#f92672>&#34;streamSettings&#34;</span>: {
        <span style=color:#f92672>&#34;sockopt&#34;</span>: {
          <span style=color:#f92672>&#34;tproxy&#34;</span>: <span style=color:#e6db74>&#34;tproxy&#34;</span>
        }
      }
    }
  ],
  <span style=color:#f92672>&#34;outbounds&#34;</span>: [
    {
       <span style=color:#960050;background-color:#1e0010>你的服务器配置</span>
    }
  ]
}
</code></pre></div><h3 ref=3-配置最大文件大开数运行xray客户端>3. 配置最大文件大开数&运行Xray客户端</h3><a class=anchor id=3-配置最大文件大开数运行xray客户端></a><p>关于最大文件大开数问题见： <strong><a href=https://guide.v2fly.org/app/tproxy.html#%E8%A7%A3%E5%86%B3-too-many-open-files-%E9%97%AE%E9%A2%98>too many open files 问题</a></strong></p><p>目前Xray服务端使用官方脚本安装的已经自动配置了最大文件大开数，无需再修改。</p><p><strong>安卓系统</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ulimit -SHn <span style=color:#ae81ff>1000000</span>
setuidgid 0:23333 <span style=color:#e6db74>&#34;运行Xray的命令&#34;</span>&amp;
</code></pre></div><p><strong>其它Linux系统</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ulimit -SHn <span style=color:#ae81ff>1000000</span>
sudo -u xray_tproxy <span style=color:#e6db74>&#34;运行Xray的命令&#34;</span>&amp;
</code></pre></div><p><em>第一条命令：</em></p><p>改变最大打开文件数，只对当前终端有效，每次启动Xray前都要运行，该命令是设置客户端的最大文件大开数</p><p><em>第二条命令：</em></p><p>以uid为0，gid不为0的用户来运行Xray客户端，后面加&代表放在后台运行</p><p><strong>检查最大文件大开数是否设置成功</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>cat /proc/Xray的pid/limits
</code></pre></div><p>找到max open files一项，应该是你设置的数值。pid的获取方法为运行<code>ps</code>或<code>ps -aux</code>或<code>ps -a</code></p><p>服务端和客户端都要检查</p><h3 ref=4-设置iptables规则>4. 设置iptables规则</h3><a class=anchor id=4-设置iptables规则></a><p><strong>代理ipv4</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ip rule add fwmark <span style=color:#ae81ff>1</span> table <span style=color:#ae81ff>100</span>
ip route add local 0.0.0.0/0 dev lo table <span style=color:#ae81ff>100</span>

<span style=color:#75715e># 代理局域网设备</span>
iptables -t mangle -N XRAY
<span style=color:#75715e>#  &#34;网关所在ipv4网段&#34; 通过运行命令&#34;ip address | grep -w inet | awk &#39;{print $2}&#39;&#34;获得，一般有多个</span>
iptables -t mangle -A XRAY -d 网关所在ipv4网段1 -j RETURN
iptables -t mangle -A XRAY -d 网关所在ipv4网段2 -j RETURN
...

<span style=color:#75715e># 组播地址直连</span>
iptables -t mangle -A XRAY -d 224.0.0.0/4 -j RETURN
iptables -t mangle -A XRAY -d 255.255.255.255/32 -j RETURN

<span style=color:#75715e>#如果网关作为主路由，则加上这一句，见：https://xtls.github.io/documents/level-2/transparent_proxy/transparent_proxy.md#iptables透明代理的其它注意事项</span>
<span style=color:#75715e>#网关LAN_IPv4地址段，运行命令&#34;ip address | grep -w &#34;inet&#34; | awk &#39;{print $2}&#39;&#34;获得，是其中的一个</span>
iptables -t mangle -A XRAY ! -s 网关LAN_IPv4地址段 -j RETURN

<span style=color:#75715e># 给 TCP 打标记 1，转发至 12345 端口</span>
<span style=color:#75715e># mark只有设置为1，流量才能被Xray任意门接受</span>
iptables -t mangle -A XRAY -p tcp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A XRAY -p udp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
<span style=color:#75715e># 应用规则</span>
iptables -t mangle -A PREROUTING -j XRAY

<span style=color:#75715e># 代理网关本机</span>
iptables -t mangle -N XRAY_MASK
iptables -t mangle -A XRAY_MASK -m owner --gid-owner <span style=color:#ae81ff>23333</span> -j RETURN
iptables -t mangle -A XRAY_MASK -d 网关所在ipv4网段1 -j RETURN
iptables -t mangle -A XRAY_MASK -d 网关所在ipv4网段2 -j RETURN
...
iptables -t mangle -A XRAY_MASK -d 224.0.0.0/4 -j RETURN
iptables -t mangle -A XRAY_MASK -d 255.255.255.255/32 -j RETURN
iptables -t mangle -A XRAY_MASK -j MARK --set-mark <span style=color:#ae81ff>1</span>
iptables -t mangle -A OUTPUT -p tcp -j XRAY_MASK
iptables -t mangle -A OUTPUT -p udp -j XRAY_MASK
</code></pre></div><p><strong>代理ipv6(可选)</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ip -6 rule add fwmark <span style=color:#ae81ff>1</span> table <span style=color:#ae81ff>106</span>
ip -6 route add local ::/0 dev lo table <span style=color:#ae81ff>106</span>

<span style=color:#75715e># 代理局域网设备</span>
ip6tables -t mangle -N XRAY6
<span style=color:#75715e># &#34;网关所在ip6网段&#34; 通过运行命令&#34;ip address | grep -w inet6 | awk &#39;{print $2}&#39;&#34;获得。</span>
ip6tables -t mangle -A XRAY6 -d 网关所在ipv6网段1 -j RETURN
ip6tables -t mangle -A XRAY6 -d 网关所在ipv6网段2 -j RETURN
...

<span style=color:#75715e># 如果网关作为主路由，则加上这一句，见：https://xtls.github.io/documents/level-2/transparent_proxy/transparent_proxy.md#iptables透明代理的其它注意事项</span>
<span style=color:#75715e># 网关LAN_IPv6地址段，运行命令&#34;ip address | grep -w &#34;inet6&#34; | awk &#39;{print $2}&#39;&#34;获得，是其中的一个</span>
ip6tables -t mangle -A XRAY6 ! -s 网关LAN_IPv6地址段 -j RETURN

ip6tables -t mangle -A XRAY6 -p udp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
ip6tables -t mangle -A XRAY6 -p tcp -j TPROXY --on-port <span style=color:#ae81ff>12345</span> --tproxy-mark <span style=color:#ae81ff>1</span>
ip6tables -t mangle -A PREROUTING -j XRAY6

<span style=color:#75715e># 代理网关本机</span>
ip6tables -t mangle -N XRAY6_MASK
ip6tables -t mangle -A XRAY6_MASK -m owner --gid-owner <span style=color:#ae81ff>23333</span> -j RETURN
ip6tables -t mangle -A XRAY6_MASK -d 网关所在ipv6网段1 -j RETURN
ip6tables -t mangle -A XRAY6_MASK -d 网关所在ipv6网段2 -j RETURN
...
ip6tables -t mangle -A XRAY6_MASK -j MARK --set-mark <span style=color:#ae81ff>1</span>
ip6tables -t mangle -A OUTPUT -p tcp -j XRAY6_MASK
ip6tables -t mangle -A OUTPUT -p udp -j XRAY6_MASK
</code></pre></div></div><div class=chevrons></div></section><section class=right-menu><div class=TableOfContents><label><i class="fas fa-align-right"></i>&nbsp;&nbsp;</label><nav><ul><li><a href=/documents/level-2/iptables_gid/>透明代理通过gid规避Xray流量</a></li></ul></nav><nav id=TableOfContents><ul><li><a href=#思路>思路</a></li><li><a href=#配置过程>配置过程</a><ul><li><a href=#1-前期准备>1. 前期准备</a></li><li><a href=#2-添加用户安卓用户请忽略>2. 添加用户(安卓用户请忽略)</a></li><li><a href=#3-配置运行xray配置iptables规则>3. 配置运行Xray，配置iptables规则</a></li></ul></li><li><a href=#下面提供一个实现tproxy全局代理的完整配置过程>下面提供一个实现tproxy全局代理的完整配置过程</a><ul><li><a href=#1-完成-前期准备1-前期准备-和-添加用户2-添加用户安卓用户请忽略>1. 完成 <strong><a href=#1-%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87>前期准备</a></strong> 和 <strong><a href=#2-%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%AE%89%E5%8D%93%E7%94%A8%E6%88%B7%E8%AF%B7%E5%BF%BD%E7%95%A5>添加用户</a></strong></a></li><li><a href=#2-准备xray配置文件>2. 准备Xray配置文件</a></li><li><a href=#3-配置最大文件大开数运行xray客户端>3. 配置最大文件大开数&运行Xray客户端</a></li><li><a href=#4-设置iptables规则>4. 设置iptables规则</a></li></ul></li></ul></nav></div><div class=Actions><nav><ul><li><a href=https://github.com/XTLS/XTLS.github.io/tree/main/content/documents/level-2/iptables_gid.md target=blank><i class="fab fa-github"></i></a></li><li><i class="fas fa-calendar"></i>23 December 2020</li></ul></nav></div></section></article><footer><footer><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/twitter><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/stack><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/XTLS><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2020-2021 ProjectX Community All Rights Reserved</small></div></div></div></footer></footer></body></html>