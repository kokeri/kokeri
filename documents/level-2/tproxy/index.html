<!doctype html><html><head><title>透明代理（TProxy）配置教程 :: Project X</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=revised content="2021-02-09T14:04:28 UTC"><meta name=description content="Project X 的文档."><meta name=author content="Project X"><title>透明代理（TProxy）配置教程 :: Project X</title><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css integrity=sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel=stylesheet><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/layout.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.main.css><link rel=stylesheet type=text/css href=https://xtls.github.io/css/style.menu.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/notice.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/tabs.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/panel.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/columns.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/children.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/attachments.css><link rel=stylesheet type=text/css href=https://xtls.github.io/sass/shortcodes/alert.css><link rel=stylesheet type=text/css href=/css/docport.css><script src=/js/docport.js></script><script type=text/javascript>var baseurl="https:\/\/xtls.github.io";</script><link rel=stylesheet href=/css/custom.css></head><body data-url=/documents/level-2/tproxy/><style type=text/css>#debug{display:-webkit-box;display:-ms-flexbox;display:flex;line-height:3.5rem;margin-bottom:.35rem;padding:0 2rem;position:fixed;left:0;right:0;top:0;top:0;min-height:150px;background-color:#fff;border:3px solid red;z-index:10000;word-wrap:all;overflow:auto}</style><header><div><div class=burger><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')">&#9776;</a></div><div><a class=baselink href=https://xtls.github.io>Project X</a></div><nav class=shortcuts><li role><a href=/about/new rel=noopener>What's New</a></li><li role><a href=https://github.com/XTLS rel=noopener>GitHub</a></li><li role><a href=https://github.com/XTLS/Xray-core/releases rel=noopener>Download</a></li><li role><a href=https://xtls.github.io/ rel=noopener>Documentation</a></li></nav></div></header><article><aside><div class=search><div class=searchbox><input data-search-input id=search-by type=text placeholder></div><script type=text/javascript src=/vendor/lunr/lunr.min.js></script><script type=text/javascript src=/vendor/auto-complete/auto-complete.js></script><link href=/vendor/auto-complete/auto-complete.css rel=stylesheet><script type=text/javascript>var baseurl="https:\/\/xtls.github.io";</script><script type=text/javascript src=/js/search.js></script></div><center><a class=github-button href=https://github.com/XTLS/Xray-core/releases data-icon=octicon-cloud-download aria-label="Download vjeantet/hugo-theme-docport on GitHub">Download</a>
<a class=github-button href=https://github.com/XTLS/Xray-core data-icon=octicon-star data-show-count=false aria-label="Star vjeantet/hugo-theme-docport on GitHub">Star</a>
<a class=github-button href=https://github.com/XTLS/Xray-core/fork data-icon=octicon-repo-forked data-show-count=true aria-label="Fork vjeantet/hugo-theme-docport on GitHub">Fork</a></center>
<script async defer src=https://buttons.github.io/buttons.js></script><div id=close_menu><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')"><i class="fa fa-lg fa-times"></i></a></div><ul class=menu><hr><li data-nav-id=https://xtls.github.io/about/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/about/>Project X&nbsp;⚡</a><ul><li data-nav-id=https://xtls.github.io/about/new/ class="dd-item
item_level_$level"><a href=/about/new/>大史记&nbsp;</a></li></ul></li><hr><li data-nav-id=https://xtls.github.io/guide/ class="dd-item alwaysopen
item_level_$level"><a href=/guide/>快速入门&nbsp;</a></li><li data-nav-id=https://xtls.github.io/config/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/config/>配置文件&nbsp;📜</a><ul><li data-nav-id=https://xtls.github.io/config/base/ class="dd-item haschildren
item_level_$level"><a href=/config/base/>基础配置模块&nbsp;</a>
<i class="fas fa-chevron-right ddexp"></i><ul><li data-nav-id=https://xtls.github.io/config/base/log/ class="dd-item
item_level_$level"><a href=/config/base/log/>日志配置</a></li><li data-nav-id=https://xtls.github.io/config/base/api/ class="dd-item
item_level_$level"><a href=/config/base/api/>API接口</a></li><li data-nav-id=https://xtls.github.io/config/base/dns/ class="dd-item
item_level_$level"><a href=/config/base/dns/>内置DNS服务器</a></li><li data-nav-id=https://xtls.github.io/config/base/routing/ class="dd-item
item_level_$level"><a href=/config/base/routing/>路由</a></li><li data-nav-id=https://xtls.github.io/config/base/policy/ class="dd-item
item_level_$level"><a href=/config/base/policy/>本地策略</a></li><li data-nav-id=https://xtls.github.io/config/base/inbounds/ class="dd-item
item_level_$level"><a href=/config/base/inbounds/>Inbounds</a></li><li data-nav-id=https://xtls.github.io/config/base/outbounds/ class="dd-item
item_level_$level"><a href=/config/base/outbounds/>Outbounds</a></li><li data-nav-id=https://xtls.github.io/config/base/transport/ class="dd-item
item_level_$level"><a href=/config/base/transport/>传输方式</a></li><li data-nav-id=https://xtls.github.io/config/base/stats/ class="dd-item
item_level_$level"><a href=/config/base/stats/>统计信息</a></li><li data-nav-id=https://xtls.github.io/config/base/reverse/ class="dd-item
item_level_$level"><a href=/config/base/reverse/>反向代理</a></li></ul></li><li data-nav-id=https://xtls.github.io/config/inbound-protocols/ class="dd-item
item_level_$level"><a href=/config/inbound-protocols/>Inbounds 可用协议列表</a></li><li data-nav-id=https://xtls.github.io/config/outbound-protocols/ class="dd-item
item_level_$level"><a href=/config/outbound-protocols/>Outbounds 可用协议列表</a></li><li data-nav-id=https://xtls.github.io/config/transports/ class="dd-item
item_level_$level"><a href=/config/transports/>传输方式列表</a></li><li data-nav-id=https://xtls.github.io/config/vless/ class="dd-item
item_level_$level"><a href=/config/vless/>VLESS 协议详解</a></li><li data-nav-id=https://xtls.github.io/config/fallback/ class="dd-item
item_level_$level"><a href=/config/fallback/>Fallbacks</a></li><li data-nav-id=https://xtls.github.io/config/xtls/ class="dd-item
item_level_$level"><a href=/config/xtls/>XTLS 深度剖析</a></li><li data-nav-id=https://xtls.github.io/config/env/ class="dd-item
item_level_$level"><a href=/config/env/>环境变量</a></li><li data-nav-id=https://xtls.github.io/config/multiple_config/ class="dd-item alwaysopen
item_level_$level"><a href=/config/multiple_config/>多文件配置</a></li></ul></li><li data-nav-id=https://xtls.github.io/documents/ class="dd-item parent haschildren
item_level_$level"><i class="fas fa-chevron-down ddexp"></i><a href=/documents/>使用心得&nbsp;📚</a><ul><li data-nav-id=https://xtls.github.io/documents/level-0/ class="dd-item alwaysopen
item_level_$level"><a href=/documents/level-0/>小小白白话文&nbsp;📙</a></li><li data-nav-id=https://xtls.github.io/documents/level-1/ class="dd-item alwaysopen
item_level_$level"><a href=/documents/level-1/>入门技巧&nbsp;📚</a></li><li data-nav-id=https://xtls.github.io/documents/level-2/ class="dd-item parent active alwaysopen
item_level_$level"><a href=/documents/level-2/>进阶文档&nbsp;📘</a></li></ul></li><li data-nav-id=https://xtls.github.io/develop/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/develop/>开发指南&nbsp;🖥️</a><ul><li data-nav-id=https://xtls.github.io/develop/intro/ class="dd-item alwaysopen
item_level_$level"><a href=/develop/intro/>开发手册</a></li><li data-nav-id=https://xtls.github.io/develop/protocols/ class="dd-item alwaysopen
item_level_$level"><a href=/develop/protocols/>协议详解</a></li></ul></li><li data-nav-id=https://xtls.github.io/faq/ class="dd-item alwaysopen
item_level_$level"><a href=/faq/>常见问答&nbsp;💬</a></li><li data-nav-id=https://xtls.github.io/caseslip/ class="dd-item alwaysopen
item_level_$level"><a href=/caseslip/>大案牍术&nbsp;</a></li><hr><li data-nav-id=https://xtls.github.io/links/ class="dd-item alwaysopen
item_level_$level"><a href=/links/>常用链接&nbsp;🤝</a></li></ul></aside><section class=page><nav id=ariane aria-label=breadcrumb><ol class=ariane><li><a class=text-link href=https://xtls.github.io></a></li><li><a class=text-link href=/documents/>使用心得</a></li><li><a class=text-link href=/documents/level-2/>进阶文档</a></li><li class=active>透明代理（TProxy）配置教程</li></ol></nav><h1>进阶文档<span>透明代理（TProxy）配置教程</span></h1><nav class=subpages><li><a title=$pagetitle href=/documents/level-2/transparent_proxy/transparent_proxy/>透明代理入门</a></li><li class=active><a title=$pagetitle href=/documents/level-2/tproxy/>透明代理（TProxy）配置教程</a></li><li><a title=$pagetitle href=/documents/level-2/iptables_gid/>透明代理通过gid规避Xray流量</a></li></nav><div class=jump-to-section><span onclick="$h=$(this);$h.next('nav').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('nav').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right';});});"><span class="fas fa-align-right"></span><i class="fas fa-chevron-right"></i></span><nav id=TableOfContents><ul><li><a href=#开始之前>开始之前</a></li><li><a href=#xray-配置>Xray 配置</a></li><li><a href=#策略路由配置>策略路由配置</a></li><li><a href=#netfilter-配置>Netfilter 配置</a></li><li><a href=#配置永久化与开机自启>配置永久化与开机自启</a></li></ul></nav></div><div class=content><p>本配置基于<a href=https://guide.v2fly.org/app/tproxy.html>TProxy 透明代理的新 V2Ray 白话文教程</a>，加入了 Xray 的新特性，使用 VLESS + XTLS Splice 方案，并将旧教程中默认出站代理的分流方式改为默认出站直连，使用者请按照实际情况进行修改。</p><p>本文中所有配置已在 Raspberry Pi 2B、Ubuntu 20.04 环境下测试成功，如在其它环境中使用请自行调整配置。</p><h2 ref=开始之前>开始之前</h2><a class=anchor id=开始之前></a><p>请检查您的设备是否有可用的网络连接，且服务端已经配置成功，客户端已经安装完毕。</p><p>需注意的是，目前很多透明代理教程都会将 Linux 系统的 IP 转发打开，但这样会导致 Splice 性能下降。详情请参考<a href=https://github.com/XTLS/Xray-core/discussions/59>大案牍术破案纪实第三篇&ndash;我们是如何破解 Splice 性能下降甚至低于 Direct 之谜的</a>。</p><p>这里我想要补充的是，很多透明代理教程会使用 Netfilter 进行分流，使直连流量直接发出而不经过 Xray，这时必须开启 IP 转发；也有的教程，如本文，会将所有流量导入 Xray 之中，由 Xray 的路由模块进行分流，这时无需开启 IP 转发。</p><h2 ref=xray-配置>Xray 配置</h2><a class=anchor id=xray-配置></a><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;log&#34;</span>: {
        <span style=color:#f92672>&#34;loglevel&#34;</span>: <span style=color:#e6db74>&#34;warning&#34;</span>,
        <span style=color:#f92672>&#34;error&#34;</span>: <span style=color:#e6db74>&#34;/var/log/xray/error.log&#34;</span>,
        <span style=color:#f92672>&#34;access&#34;</span>: <span style=color:#e6db74>&#34;/var/log/xray/access.log&#34;</span>
    },
    <span style=color:#f92672>&#34;inbounds&#34;</span>: [
        {
            <span style=color:#f92672>&#34;tag&#34;</span>: <span style=color:#e6db74>&#34;all-in&#34;</span>,
            <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>12345</span>,
            <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;dokodemo-door&#34;</span>,
            <span style=color:#f92672>&#34;settings&#34;</span>: {
                <span style=color:#f92672>&#34;network&#34;</span>: <span style=color:#e6db74>&#34;tcp,udp&#34;</span>,
                <span style=color:#f92672>&#34;followRedirect&#34;</span>: <span style=color:#66d9ef>true</span>
            },
            <span style=color:#f92672>&#34;sniffing&#34;</span>: {
                <span style=color:#f92672>&#34;enabled&#34;</span>: <span style=color:#66d9ef>true</span>,
                <span style=color:#f92672>&#34;destOverride&#34;</span>: [
                    <span style=color:#e6db74>&#34;http&#34;</span>,
                    <span style=color:#e6db74>&#34;tls&#34;</span>
                ]
            },
            <span style=color:#f92672>&#34;streamSettings&#34;</span>: {
                <span style=color:#f92672>&#34;sockopt&#34;</span>: {
                    <span style=color:#f92672>&#34;tproxy&#34;</span>: <span style=color:#e6db74>&#34;tproxy&#34;</span>
                }
            }
        }
    ],
    <span style=color:#f92672>&#34;outbounds&#34;</span>: [
        {
            <span style=color:#f92672>&#34;tag&#34;</span>: <span style=color:#e6db74>&#34;direct&#34;</span>,
            <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;freedom&#34;</span>,
            <span style=color:#f92672>&#34;settings&#34;</span>: {
                <span style=color:#f92672>&#34;domainStrategy&#34;</span>: <span style=color:#e6db74>&#34;UseIPv4&#34;</span>
            },
            <span style=color:#f92672>&#34;streamSettings&#34;</span>: {
                <span style=color:#f92672>&#34;sockopt&#34;</span>: {
                    <span style=color:#f92672>&#34;mark&#34;</span>: <span style=color:#ae81ff>2</span>
                }
            }
        },
        {
            <span style=color:#f92672>&#34;tag&#34;</span>: <span style=color:#e6db74>&#34;proxy&#34;</span>,
            <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;vless&#34;</span>,
            <span style=color:#f92672>&#34;settings&#34;</span>: {
                <span style=color:#f92672>&#34;vnext&#34;</span>: [
                    {
                        <span style=color:#f92672>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;服务端域名&#34;</span>,
                        <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>443</span>,
                        <span style=color:#f92672>&#34;users&#34;</span>: [
                            {
                                <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;UUID&#34;</span>,
                                <span style=color:#f92672>&#34;flow&#34;</span>: <span style=color:#e6db74>&#34;xtls-rprx-splice&#34;</span>,
                                <span style=color:#f92672>&#34;encryption&#34;</span>: <span style=color:#e6db74>&#34;none&#34;</span>
                            }
                        ]
                    }
                ]
            },
            <span style=color:#f92672>&#34;streamSettings&#34;</span>: {
                <span style=color:#f92672>&#34;network&#34;</span>: <span style=color:#e6db74>&#34;tcp&#34;</span>,
                <span style=color:#f92672>&#34;security&#34;</span>: <span style=color:#e6db74>&#34;xtls&#34;</span>,
                <span style=color:#f92672>&#34;sockopt&#34;</span>: {
                    <span style=color:#f92672>&#34;mark&#34;</span>: <span style=color:#ae81ff>2</span>
                }
            }
        },
        {
            <span style=color:#f92672>&#34;tag&#34;</span>: <span style=color:#e6db74>&#34;block&#34;</span>,
            <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;blackhole&#34;</span>,
            <span style=color:#f92672>&#34;settings&#34;</span>: {
                <span style=color:#f92672>&#34;response&#34;</span>: {
                    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;http&#34;</span>
                }
            }
        },
        {
            <span style=color:#f92672>&#34;tag&#34;</span>: <span style=color:#e6db74>&#34;dns-out&#34;</span>,
            <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;dns&#34;</span>,
            <span style=color:#f92672>&#34;settings&#34;</span>: {
                <span style=color:#f92672>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;8.8.8.8&#34;</span>
            },
            <span style=color:#f92672>&#34;proxySettings&#34;</span>: {
                <span style=color:#f92672>&#34;tag&#34;</span>: <span style=color:#e6db74>&#34;proxy&#34;</span>
            },
            <span style=color:#f92672>&#34;streamSettings&#34;</span>: {
                <span style=color:#f92672>&#34;sockopt&#34;</span>: {
                    <span style=color:#f92672>&#34;mark&#34;</span>: <span style=color:#ae81ff>2</span>
                }
            }
        }
    ],
    <span style=color:#f92672>&#34;dns&#34;</span>: {
        <span style=color:#f92672>&#34;hosts&#34;</span>: {
            <span style=color:#f92672>&#34;服务端域名&#34;</span>: <span style=color:#e6db74>&#34;服务端 IP&#34;</span>
        },
        <span style=color:#f92672>&#34;servers&#34;</span>: [
            {
                <span style=color:#f92672>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;119.29.29.29&#34;</span>,
                <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>53</span>,
                <span style=color:#f92672>&#34;domains&#34;</span>: [
                    <span style=color:#e6db74>&#34;geosite:cn&#34;</span>
                ],
                <span style=color:#f92672>&#34;expectIPs&#34;</span>: [
                    <span style=color:#e6db74>&#34;geoip:cn&#34;</span>
                ]
            },
            {
                <span style=color:#f92672>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;223.5.5.5&#34;</span>,
                <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>53</span>,
                <span style=color:#f92672>&#34;domains&#34;</span>: [
                    <span style=color:#e6db74>&#34;geosite:cn&#34;</span>
                ],
                <span style=color:#f92672>&#34;expectIPs&#34;</span>: [
                    <span style=color:#e6db74>&#34;geoip:cn&#34;</span>
                ]
            },
            <span style=color:#e6db74>&#34;8.8.8.8&#34;</span>,
            <span style=color:#e6db74>&#34;1.1.1.1&#34;</span>,
            <span style=color:#e6db74>&#34;https+local://doh.dns.sb/dns-query&#34;</span>
        ]
    },
    <span style=color:#f92672>&#34;routing&#34;</span>: {
        <span style=color:#f92672>&#34;domainStrategy&#34;</span>: <span style=color:#e6db74>&#34;IPIfNonMatch&#34;</span>,
        <span style=color:#f92672>&#34;rules&#34;</span>: [
            {
                <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;field&#34;</span>,
                <span style=color:#f92672>&#34;inboundTag&#34;</span>: [
                    <span style=color:#e6db74>&#34;all-in&#34;</span>
                ],
                <span style=color:#f92672>&#34;port&#34;</span>: <span style=color:#ae81ff>53</span>,
                <span style=color:#f92672>&#34;outboundTag&#34;</span>: <span style=color:#e6db74>&#34;dns-out&#34;</span>
            },
            {
                <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;field&#34;</span>,
                <span style=color:#f92672>&#34;ip&#34;</span>: [
                    <span style=color:#e6db74>&#34;119.29.29.29&#34;</span>,
                    <span style=color:#e6db74>&#34;223.5.5.5&#34;</span>
                ],
                <span style=color:#f92672>&#34;outboundTag&#34;</span>: <span style=color:#e6db74>&#34;direct&#34;</span>
            },
            {
                <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;field&#34;</span>,
                <span style=color:#f92672>&#34;ip&#34;</span>: [
                    <span style=color:#e6db74>&#34;8.8.8.8&#34;</span>,
                    <span style=color:#e6db74>&#34;1.1.1.1&#34;</span>
                ],
                <span style=color:#f92672>&#34;outboundTag&#34;</span>: <span style=color:#e6db74>&#34;proxy&#34;</span>
            },
            {
                <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;field&#34;</span>,
                <span style=color:#f92672>&#34;domain&#34;</span>: [
                    <span style=color:#e6db74>&#34;geosite:category-ads-all&#34;</span>
                ],
                <span style=color:#f92672>&#34;outboundTag&#34;</span>: <span style=color:#e6db74>&#34;block&#34;</span>
            },
            {
                <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;field&#34;</span>,
                <span style=color:#f92672>&#34;domain&#34;</span>: [
                    <span style=color:#e6db74>&#34;geosite:geolocation-!cn&#34;</span>
                ],
                <span style=color:#f92672>&#34;outboundTag&#34;</span>: <span style=color:#e6db74>&#34;proxy&#34;</span>
            },
            {
                <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;field&#34;</span>,
                <span style=color:#f92672>&#34;ip&#34;</span>: [
                    <span style=color:#e6db74>&#34;geoip:jp&#34;</span>,
                    <span style=color:#e6db74>&#34;geoip:us&#34;</span>,
                    <span style=color:#e6db74>&#34;geoip:sg&#34;</span>,
                    <span style=color:#e6db74>&#34;geoip:hk&#34;</span>,
                    <span style=color:#e6db74>&#34;geoip:tw&#34;</span>,
                    <span style=color:#e6db74>&#34;109.239.140.0/24&#34;</span>,
                    <span style=color:#e6db74>&#34;14.102.250.18&#34;</span>,
                    <span style=color:#e6db74>&#34;14.102.250.19&#34;</span>,
                    <span style=color:#e6db74>&#34;149.154.164.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;149.154.168.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;149.154.172.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;174.142.105.153&#34;</span>,
                    <span style=color:#e6db74>&#34;50.7.31.230&#34;</span>,
                    <span style=color:#e6db74>&#34;67.220.91.15&#34;</span>,
                    <span style=color:#e6db74>&#34;67.220.91.18&#34;</span>,
                    <span style=color:#e6db74>&#34;67.220.91.23&#34;</span>,
                    <span style=color:#e6db74>&#34;69.65.19.160&#34;</span>,
                    <span style=color:#e6db74>&#34;72.52.81.22&#34;</span>,
                    <span style=color:#e6db74>&#34;85.17.73.31&#34;</span>,
                    <span style=color:#e6db74>&#34;91.108.4.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;91.108.56.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;91.108.56.0/23&#34;</span>,
                    <span style=color:#e6db74>&#34;108.177.120.94&#34;</span>,
                    <span style=color:#e6db74>&#34;108.177.120.0/24&#34;</span>,
                    <span style=color:#e6db74>&#34;172.217.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;74.125.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;23.246.0.0/18&#34;</span>,
                    <span style=color:#e6db74>&#34;37.77.184.0/21&#34;</span>,
                    <span style=color:#e6db74>&#34;45.57.0.0/17&#34;</span>,
                    <span style=color:#e6db74>&#34;64.120.128.0/17&#34;</span>,
                    <span style=color:#e6db74>&#34;66.197.128.0/17&#34;</span>,
                    <span style=color:#e6db74>&#34;108.175.32.0/20&#34;</span>,
                    <span style=color:#e6db74>&#34;192.173.64.0/18&#34;</span>,
                    <span style=color:#e6db74>&#34;198.38.96.0/19&#34;</span>,
                    <span style=color:#e6db74>&#34;198.45.48.0/20&#34;</span>,
                    <span style=color:#e6db74>&#34;173.245.48.0/20&#34;</span>,
                    <span style=color:#e6db74>&#34;103.21.244.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;103.22.200.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;103.31.4.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;141.101.64.0/18&#34;</span>,
                    <span style=color:#e6db74>&#34;108.162.192.0/18&#34;</span>,
                    <span style=color:#e6db74>&#34;190.93.240.0/20&#34;</span>,
                    <span style=color:#e6db74>&#34;188.114.96.0/20&#34;</span>,
                    <span style=color:#e6db74>&#34;197.234.240.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;198.41.128.0/17&#34;</span>,
                    <span style=color:#e6db74>&#34;162.158.0.0/15&#34;</span>,
                    <span style=color:#e6db74>&#34;104.16.0.0/12&#34;</span>,
                    <span style=color:#e6db74>&#34;172.64.0.0/13&#34;</span>,
                    <span style=color:#e6db74>&#34;131.0.72.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;144.220.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;52.124.128.0/17&#34;</span>,
                    <span style=color:#e6db74>&#34;54.230.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;54.239.128.0/18&#34;</span>,
                    <span style=color:#e6db74>&#34;52.82.128.0/19&#34;</span>,
                    <span style=color:#e6db74>&#34;99.84.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;204.246.172.0/24&#34;</span>,
                    <span style=color:#e6db74>&#34;54.239.192.0/19&#34;</span>,
                    <span style=color:#e6db74>&#34;70.132.0.0/18&#34;</span>,
                    <span style=color:#e6db74>&#34;13.32.0.0/15&#34;</span>,
                    <span style=color:#e6db74>&#34;205.251.208.0/20&#34;</span>,
                    <span style=color:#e6db74>&#34;13.224.0.0/14&#34;</span>,
                    <span style=color:#e6db74>&#34;13.35.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;204.246.164.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;204.246.168.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;71.152.0.0/17&#34;</span>,
                    <span style=color:#e6db74>&#34;216.137.32.0/19&#34;</span>,
                    <span style=color:#e6db74>&#34;205.251.249.0/24&#34;</span>,
                    <span style=color:#e6db74>&#34;99.86.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;52.46.0.0/18&#34;</span>,
                    <span style=color:#e6db74>&#34;52.84.0.0/15&#34;</span>,
                    <span style=color:#e6db74>&#34;204.246.173.0/24&#34;</span>,
                    <span style=color:#e6db74>&#34;130.176.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;205.251.200.0/21&#34;</span>,
                    <span style=color:#e6db74>&#34;204.246.174.0/23&#34;</span>,
                    <span style=color:#e6db74>&#34;64.252.128.0/18&#34;</span>,
                    <span style=color:#e6db74>&#34;205.251.254.0/24&#34;</span>,
                    <span style=color:#e6db74>&#34;143.204.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;205.251.252.0/23&#34;</span>,
                    <span style=color:#e6db74>&#34;204.246.176.0/20&#34;</span>,
                    <span style=color:#e6db74>&#34;13.249.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;54.240.128.0/18&#34;</span>,
                    <span style=color:#e6db74>&#34;205.251.250.0/23&#34;</span>,
                    <span style=color:#e6db74>&#34;52.222.128.0/17&#34;</span>,
                    <span style=color:#e6db74>&#34;54.182.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;54.192.0.0/16&#34;</span>,
                    <span style=color:#e6db74>&#34;103.2.30.0/23&#34;</span>,
                    <span style=color:#e6db74>&#34;125.209.208.0/20&#34;</span>,
                    <span style=color:#e6db74>&#34;147.92.128.0/17&#34;</span>,
                    <span style=color:#e6db74>&#34;203.104.144.0/21&#34;</span>,
                    <span style=color:#e6db74>&#34;91.108.8.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;91.108.12.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;91.108.16.0/22&#34;</span>,
                    <span style=color:#e6db74>&#34;149.154.160.0/20&#34;</span>,
                    <span style=color:#e6db74>&#34;3.123.36.126/32&#34;</span>,
                    <span style=color:#e6db74>&#34;35.157.215.84/32&#34;</span>,
                    <span style=color:#e6db74>&#34;35.157.217.255/32&#34;</span>,
                    <span style=color:#e6db74>&#34;52.58.209.134/32&#34;</span>,
                    <span style=color:#e6db74>&#34;54.93.124.31/32&#34;</span>,
                    <span style=color:#e6db74>&#34;54.162.243.80/32&#34;</span>,
                    <span style=color:#e6db74>&#34;54.173.34.141/32&#34;</span>,
                    <span style=color:#e6db74>&#34;54.235.23.242/32&#34;</span>,
                    <span style=color:#e6db74>&#34;169.45.248.118/32&#34;</span>
                ],
                <span style=color:#f92672>&#34;outboundTag&#34;</span>: <span style=color:#e6db74>&#34;proxy&#34;</span>
            }
        ]
    }
}
</code></pre></div><div class="notices primary"><p><strong>TIP</strong></p><p>本配置会劫持所有发往 53 端口的流量以解决 DNS 污染问题，所以客户端和本机的 DNS 服务器的地址可以随意配置。</p><p>此外，由于内置的 <code>geoip.dat</code> 文件无法完美实现路由分流，故在配置文件中格外添加了一些 IP。</p></div><h2 ref=策略路由配置>策略路由配置</h2><a class=anchor id=策略路由配置></a><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback># ip route add local default dev lo table 100 # 添加路由表 100
# ip rule add fwmark 1 table 100 # 为路由表 100 设定规则
</code></pre></div><h2 ref=netfilter-配置>Netfilter 配置</h2><a class=anchor id=netfilter-配置></a><div class="notices warning"><p><strong>注意</strong></p><p>nftables 配置与 iptables 配置二选一，不可同时使用。</p></div><div class=tabs><input type=radio name=tabs-2 id=tabs-2-0 checked>
<label for=tabs-2-0>nftables</label><div class=tab><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback>#!/usr/sbin/nft -f
<p>flush ruleset</p>
<p>define RESERVED_IP = {
10.0.0.0/8,
100.64.0.0/10,
127.0.0.0/8,
169.254.0.0/16,
172.16.0.0/12,
192.0.0.0/24,
224.0.0.0/4,
240.0.0.0/4,
255.255.255.255/32
}</p>
<p>table ip xray {
chain prerouting {
type filter hook prerouting priority mangle; policy accept;
ip daddr $RESERVED_IP return
ip daddr 192.168.0.0/16 tcp dport != 53 return
ip daddr 192.168.0.0/16 udp dport != 53 return
ip protocol tcp tproxy to 127.0.0.1:12345 meta mark set 1
ip protocol udp tproxy to 127.0.0.1:12345 meta mark set 1
}
chain output {
type route hook output priority mangle; policy accept;
ip daddr $RESERVED_IP return
ip daddr 192.168.0.0/16 tcp dport != 53 return
ip daddr 192.168.0.0/16 udp dport != 53 return
meta mark 2 return
ip protocol tcp meta mark set 1
ip protocol udp meta mark set 1
}
}
</code></pre></div><div class="notices primary"><p><strong>使用方法</strong></p></p><p>将上述配置写入一个文件（如 <code>nft.conf</code>），之后将该文件赋予可执行权限，最后使用 root 权限执行该文件即可（<code># ./nft.conf</code>）。</p></div></div><input type=radio name=tabs-2 id=tabs-2-1>
<label for=tabs-2-1>iptables</label><div class=tab><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback>iptables -t mangle -N XRAY
iptables -t mangle -A XRAY -d 10.0.0.0/8 -j RETURN
iptables -t mangle -A XRAY -d 100.64.0.0/10 -j RETURN
iptables -t mangle -A XRAY -d 127.0.0.0/8 -j RETURN
iptables -t mangle -A XRAY -d 169.254.0.0/16 -j RETURN
iptables -t mangle -A XRAY -d 172.16.0.0/12 -j RETURN
iptables -t mangle -A XRAY -d 192.0.0.0/24 -j RETURN
iptables -t mangle -A XRAY -d 224.0.0.0/4 -j RETURN
iptables -t mangle -A XRAY -d 240.0.0.0/4 -j RETURN
iptables -t mangle -A XRAY -d 255.255.255.255/32 -j RETURN
iptables -t mangle -A XRAY -d 192.168.0.0/16 -p tcp ! --dport 53 -j RETURN
iptables -t mangle -A XRAY -d 192.168.0.0/16 -p udp ! --dport 53 -j RETURN
iptables -t mangle -A XRAY -p tcp -j TPROXY --on-port 12345 --tproxy-mark 1
iptables -t mangle -A XRAY -p udp -j TPROXY --on-port 12345 --tproxy-mark 1
iptables -t mangle -A PREROUTING -j XRAY

iptables -t mangle -N XRAY_SELF
iptables -t mangle -A XRAY_SELF -d 10.0.0.0/8 -j RETURN
iptables -t mangle -A XRAY_SELF -d 100.64.0.0/10 -j RETURN
iptables -t mangle -A XRAY_SELF -d 127.0.0.0/8 -j RETURN
iptables -t mangle -A XRAY_SELF -d 169.254.0.0/16 -j RETURN
iptables -t mangle -A XRAY_SELF -d 172.16.0.0/12 -j RETURN
iptables -t mangle -A XRAY_SELF -d 192.0.0.0/24 -j RETURN
iptables -t mangle -A XRAY_SELF -d 224.0.0.0/4 -j RETURN
iptables -t mangle -A XRAY_SELF -d 240.0.0.0/4 -j RETURN
iptables -t mangle -A XRAY_SELF -d 255.255.255.255/32 -j RETURN
iptables -t mangle -A XRAY_SELF -d 192.168.0.0/16 -p tcp ! --dport 53 -j RETURN
iptables -t mangle -A XRAY_SELF -d 192.168.0.0/16 -p udp ! --dport 53 -j RETURN
iptables -t mangle -A XRAY_SELF -m mark --mark 2 -j RETURN
iptables -t mangle -A XRAY_SELF -p tcp -j MARK --set-mark 1
iptables -t mangle -A XRAY_SELF -p udp -j MARK --set-mark 1
iptables -t mangle -A OUTPUT -j XRAY_SELF
</code></pre></div></div></div><p>配置完成后，将局域网内其它设备的默认网关改为该设备 IP，就可以直接翻墙了。在其它主机和本机皆测试成功后，可进行下一步配置。</p><h2 ref=配置永久化与开机自启>配置永久化与开机自启</h2><a class=anchor id=配置永久化与开机自启></a><div class=tabs><input type=radio name=tabs-3 id=tabs-3-0 checked>
<label for=tabs-3-0>nftables</label><div class=tab><p>首先将已经编辑好的 nftables 配置文件移动到 <code>/etc</code> 目录下，并重命名为 <code>nftables.conf</code>。然后编辑 <code>/lib/systemd/system/nftables.service</code>。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ini data-lang=ini><span style=color:#66d9ef>[Unit]</span>
<span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>nftables</span>
<span style=color:#a6e22e>Documentation</span><span style=color:#f92672>=</span><span style=color:#e6db74>man:nft(8) http://wiki.nftables.org</span>
<span style=color:#a6e22e>Wants</span><span style=color:#f92672>=</span><span style=color:#e6db74>network-pre.target</span>
<span style=color:#a6e22e>Before</span><span style=color:#f92672>=</span><span style=color:#e6db74>network-pre.target shutdown.target</span>
<span style=color:#a6e22e>Conflicts</span><span style=color:#f92672>=</span><span style=color:#e6db74>shutdown.target</span>
<span style=color:#a6e22e>DefaultDependencies</span><span style=color:#f92672>=</span><span style=color:#e6db74>no</span>
<p><span style=color:#66d9ef>[Service]</span>
<span style=color:#a6e22e>Type</span><span style=color:#f92672>=</span><span style=color:#e6db74>oneshot</span>
<span style=color:#a6e22e>RemainAfterExit</span><span style=color:#f92672>=</span><span style=color:#e6db74>yes</span>
<span style=color:#a6e22e>StandardInput</span><span style=color:#f92672>=</span><span style=color:#e6db74>null</span>
<span style=color:#a6e22e>ProtectSystem</span><span style=color:#f92672>=</span><span style=color:#e6db74>full</span>
<span style=color:#a6e22e>ProtectHome</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
<span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/sbin/nft -f /etc/nftables.conf ; /usr/sbin/ip route add local default dev lo table 100 ; /usr/sbin/ip rule add fwmark 1 table 100</span>
<span style=color:#a6e22e>ExecReload</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/sbin/nft -f /etc/nftables.conf</span>
<span style=color:#a6e22e>ExecStop</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/sbin/nft flush ruleset ; /usr/sbin/ip route del local default dev lo table 100 ; /usr/sbin/ip rule del table 100</span></p>
<p><span style=color:#66d9ef>[Install]</span>
<span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>sysinit.target</span>
</code></pre></div><p>最后 enable 即可。</p></p></div><input type=radio name=tabs-3 id=tabs-3-1>
<label for=tabs-3-1>iptables</label><div class=tab><p>关于 iptables 的永久化，建议直接安装 <code>iptables-persistent</code>。</p><p>安装过程中会提示你选择“是否保存配置”，如果已经将 iptables 配置写入系统，那么此时选择“是”即可；如果尚未写入也没有关系，安装完毕后将配置写入，然后执行 <code>netfilter-persistent save</code> 即可（需要 root 权限）。</p><p>之后编辑 <code>/lib/systemd/system/netfilter-persistent.service</code>。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ini data-lang=ini><span style=color:#66d9ef>[Unit]</span>
<span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>netfilter persistent configuration</span>
<span style=color:#a6e22e>DefaultDependencies</span><span style=color:#f92672>=</span><span style=color:#e6db74>no</span>
<span style=color:#a6e22e>Wants</span><span style=color:#f92672>=</span><span style=color:#e6db74>network-pre.target systemd-modules-load.service local-fs.target</span>
<span style=color:#a6e22e>Before</span><span style=color:#f92672>=</span><span style=color:#e6db74>network-pre.target shutdown.target</span>
<span style=color:#a6e22e>After</span><span style=color:#f92672>=</span><span style=color:#e6db74>systemd-modules-load.service local-fs.target</span>
<span style=color:#a6e22e>Conflicts</span><span style=color:#f92672>=</span><span style=color:#e6db74>shutdown.target</span>
<span style=color:#a6e22e>Documentation</span><span style=color:#f92672>=</span><span style=color:#e6db74>man:netfilter-persistent(8)</span>

<span style=color:#66d9ef>[Service]</span>
<span style=color:#a6e22e>Type</span><span style=color:#f92672>=</span><span style=color:#e6db74>oneshot</span>
<span style=color:#a6e22e>RemainAfterExit</span><span style=color:#f92672>=</span><span style=color:#e6db74>yes</span>
<span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/sbin/netfilter-persistent start ; /usr/sbin/ip route add local default dev lo table 100 ; /usr/sbin/ip rule add fwmark 1 table 100</span>
<span style=color:#a6e22e>ExecStop</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/sbin/netfilter-persistent stop ; /usr/sbin/ip route del local default dev lo table 100 ; /usr/sbin/ip rule del table 100</span>

<span style=color:#66d9ef>[Install]</span>
<span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>multi-user.target</span>
</code></pre></div></div></div></div><div class=chevrons></div></section><section class=right-menu><div class=TableOfContents><label><i class="fas fa-align-right"></i>&nbsp;&nbsp;</label><nav><ul><li><a href=/documents/level-2/tproxy/>透明代理（TProxy）配置教程</a></li></ul></nav><nav id=TableOfContents><ul><li><a href=#开始之前>开始之前</a></li><li><a href=#xray-配置>Xray 配置</a></li><li><a href=#策略路由配置>策略路由配置</a></li><li><a href=#netfilter-配置>Netfilter 配置</a></li><li><a href=#配置永久化与开机自启>配置永久化与开机自启</a></li></ul></nav></div><div class=Actions><nav><ul><li><a href=https://github.com/XTLS/XTLS.github.io/tree/main/content/documents/level-2/tproxy.md target=blank><i class="fab fa-github"></i></a></li><li><i class="fas fa-calendar"></i>23 December 2020</li></ul></nav></div></section></article><footer><footer><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/twitter><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/stack><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/XTLS><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2020-2021 ProjectX Community All Rights Reserved</small></div></div></div></footer></footer></body></html>